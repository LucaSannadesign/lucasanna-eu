---
const GA4_ID = 'G-MPEL6FVCXD';
---

<script>
	(function() {
		const GA4_ID = 'G-MPEL6FVCXD';
		const STORAGE_KEY = 'cookie_consent';
		
		function checkAnalyticsConsent() {
			try {
				const stored = localStorage.getItem(STORAGE_KEY);
				if (!stored) return false;
				
				// Supporta sia formato stringa legacy che JSON
				if (stored === 'accepted') {
					return true; // Legacy: accepted = analytics true
				}
				
				const consent = JSON.parse(stored);
				return consent.analytics === true;
			} catch {
				return false;
			}
		}
		
		function loadGA4() {
			// Previeni doppio caricamento
			if (window.__ga4_loaded) return;
			
			// Inizializza dataLayer e gtag PRIMA di caricare lo script
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				window.dataLayer.push(arguments);
			}
			window.gtag = gtag;
			
			// Configura GA4 con anonymize_ip
			gtag('js', new Date());
			gtag('config', GA4_ID, { anonymize_ip: true });
			
			// Carica script gtag.js dinamicamente
			const script = document.createElement('script');
			script.async = true;
			script.src = `https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`;
			document.head.appendChild(script);
			
			window.__ga4_loaded = true;
		}
		
		function disableGA4() {
			// Se GA4 è già caricato, disabilita il tracking
			if (window.gtag && window.dataLayer) {
				// Sostituisci gtag con funzione no-op per non inviare più eventi
				window.gtag = function() {
					// Non inviare eventi se consenso rifiutato
				};
				// Pulisci dataLayer per evitare invio di eventi pendenti
				if (window.dataLayer && Array.isArray(window.dataLayer)) {
					window.dataLayer = [];
				}
			}
		}
		
		// Carica GA4 se consenso già presente al load
		if (checkAnalyticsConsent()) {
			loadGA4();
		}
		
		// Ascolta evento consenso cambiato
		window.addEventListener('cookie-consent-changed', (e) => {
			const detail = (e instanceof CustomEvent ? e.detail : undefined);
			if (detail?.analytics === true) {
				loadGA4();
			}
		});
	})();
</script>

