---
import { existsSync } from 'fs';
import { join } from 'path';

interface Props {
	size?: 'sm' | 'lg';
	eager?: boolean;
	variant?: 'default' | 'featured';
	linkTo?: string;
}

const { size = 'lg', eager = false, variant = 'default', linkTo } = Astro.props;

// Verifica se il file WebP esiste
const webpPath = join(process.cwd(), 'public', 'images', 'ritratto-luca-sanna.webp');
const hasWebP = existsSync(webpPath);

// Dimensioni basate sulla prop size
const dimensions = {
	sm: { width: 200, height: 200 },
	lg: { width: 280, height: 280 }
};

const { width, height } = dimensions[size];
const loading = eager ? 'eager' : 'lazy';
const isFeatured = variant === 'featured';
const isClickable = !!linkTo;
---

{isClickable ? (
	<a 
		href={linkTo}
		class={`portraitLink ${isFeatured ? 'portrait--featured' : 'portrait--default'}`}
		style={!isFeatured ? `width: ${width}px;` : ''}
		aria-label="Vai alla pagina Chi sono"
	>
		<picture>
			{hasWebP && (
				<source 
					srcset="/images/ritratto-luca-sanna.webp" 
					type="image/webp"
				/>
			)}
			<img
				src="/images/ritratto-luca-sanna.png"
				alt="Ritratto di Luca Sanna"
				width="800"
				height="800"
				class="portrait__image"
				loading={loading}
				decoding="async"
			/>
		</picture>
		<span class="portraitOverlay" aria-hidden="true"></span>
		<span class="portraitLabel">Chi sono â†’</span>
	</a>
) : (
	<div class={`portrait ${isFeatured ? 'portrait--featured' : 'portrait--default'}`} style={!isFeatured ? `width: ${width}px;` : ''}>
		<picture>
			{hasWebP && (
				<source 
					srcset="/images/ritratto-luca-sanna.webp" 
					type="image/webp"
				/>
			)}
			<img
				src="/images/ritratto-luca-sanna.png"
				alt="Ritratto di Luca Sanna"
				width="800"
				height="800"
				class="portrait__image"
				loading={loading}
				decoding="async"
			/>
		</picture>
	</div>
)}

<style>
	/* Portrait base styles */
	.portrait,
	.portraitLink {
		position: relative;
		display: block;
		aspect-ratio: 1 / 1;
	}

	.portrait--default {
		border-radius: var(--radius-md);
		overflow: hidden;
	}

	.portrait--featured {
		width: clamp(200px, 26vw, 340px);
	}

	.portrait__image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		transition: transform 240ms ease, opacity 240ms ease;
	}

	/* Default variant: simple rounded corners */
	.portrait--default .portrait__image {
		border-radius: inherit;
	}

	/* Featured variant: blend into background with lighter feather */
	.portrait--featured .portrait__image {
		border-radius: 50%;
		/* Lighter feather - face fully visible, subtle fade on edges */
		-webkit-mask-image: radial-gradient(
			circle at 50% 45%,
			black 0%,
			black 65%,
			rgba(0,0,0,0.85) 80%,
			rgba(0,0,0,0.5) 92%,
			transparent 100%
		);
		mask-image: radial-gradient(
			circle at 50% 45%,
			black 0%,
			black 65%,
			rgba(0,0,0,0.85) 80%,
			rgba(0,0,0,0.5) 92%,
			transparent 100%
		);
	}

	/* Desktop: lighter feather - face fully preserved */
	@media (min-width: 768px) {
		.portrait--featured .portrait__image {
			/* Circle centered to preserve face, lighter fade */
			-webkit-mask-image: radial-gradient(
				circle at 52% 42%,
				black 0%,
				black 70%,
				rgba(0,0,0,0.9) 85%,
				rgba(0,0,0,0.6) 95%,
				transparent 100%
			);
			mask-image: radial-gradient(
				circle at 52% 42%,
				black 0%,
				black 70%,
				rgba(0,0,0,0.9) 85%,
				rgba(0,0,0,0.6) 95%,
				transparent 100%
			);
		}
	}

	/* Mobile: simpler approach, no hard edges */
	@media (max-width: 767px) {
		.portrait--featured {
			width: clamp(160px, 50vw, 240px);
			margin-inline: auto;
		}
	}

	/* ===== Clickable Portrait Link ===== */
	.portraitLink {
		text-decoration: none;
		cursor: pointer;
		outline: none;
	}

	/* Overlay - positioned at bottom, doesn't cover face */
	.portraitOverlay {
		position: absolute;
		bottom: 0;
		left: 50%;
		transform: translateX(-50%);
		width: 70%;
		height: 40%;
		background: radial-gradient(
			ellipse at 50% 100%,
			rgb(var(--ink) / 0.35) 0%,
			transparent 70%
		);
		opacity: 0;
		transition: opacity 240ms ease;
		pointer-events: none;
		border-radius: 50%;
	}

	/* Label - positioned below center, above shoulders */
	.portraitLabel {
		position: absolute;
		bottom: 18%;
		left: 50%;
		transform: translateX(-50%) translateY(6px);
		font-size: var(--text-xs);
		font-weight: 600;
		color: rgb(var(--paper));
		background: rgb(var(--ink) / 0.85);
		padding: 0.35rem 0.75rem;
		border-radius: 9999px;
		opacity: 0;
		transition: opacity 240ms ease, transform 240ms ease;
		white-space: nowrap;
		pointer-events: none;
	}

	/* Hover & Focus states (desktop) */
	@media (min-width: 641px) {
		.portraitLink:hover .portrait__image,
		.portraitLink:focus-visible .portrait__image {
			transform: scale(1.03);
		}

		.portraitLink:hover .portraitOverlay,
		.portraitLink:focus-visible .portraitOverlay {
			opacity: 1;
		}

		.portraitLink:hover .portraitLabel,
		.portraitLink:focus-visible .portraitLabel {
			opacity: 1;
			transform: translateX(-50%) translateY(0);
		}
	}

	/* Focus ring */
	.portraitLink:focus-visible {
		outline: 2px solid rgb(var(--accent));
		outline-offset: 4px;
		border-radius: 50%;
	}

	/* Mobile: label always visible but subtle */
	@media (max-width: 640px) {
		.portraitLabel {
			opacity: 0.9;
			transform: translateX(-50%) translateY(0);
			font-size: 0.65rem;
			padding: 0.25rem 0.5rem;
			bottom: 12%;
		}

		.portraitOverlay {
			display: none;
		}
	}

	/* Reduced motion */
	@media (prefers-reduced-motion: reduce) {
		.portrait__image,
		.portraitOverlay,
		.portraitLabel {
			transition: none;
		}

		.portraitLink:hover .portrait__image,
		.portraitLink:focus-visible .portrait__image {
			transform: none;
		}
	}
</style>

