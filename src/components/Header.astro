---
const currentPath = Astro.url.pathname;
const isActive = (path: string) => {
	if (path === '/') return currentPath === '/';
	return currentPath.startsWith(path);
};
---

<header 
	class="site-header fixed top-0 left-0 right-0 z-50 transition-all duration-300"
	id="header"
	data-site-header
	data-header-state="transparent"
>
	<div class="container-unified">
		<div class="header-inner">
			<!-- Left: Logo -->
			<a href="/" class="header-logo" aria-label="Luca Sanna — Home">
				<img
					src="/images/logo-lucasanna.svg"
					width="140"
					height="28"
					alt="Luca Sanna"
					class="h-7 w-auto"
					loading="eager"
					decoding="async"
				/>
			</a>

			<!-- Center: Desktop Nav (hidden on mobile) -->
			<nav class="desktopNav" aria-label="Navigazione principale">
				<ul class="nav-list" role="list">
					<li>
						<a 
							class="nav-link" 
							href="/case-studies" 
							aria-current={isActive('/case-studies') ? 'page' : undefined}
						>
							Case studies
						</a>
					</li>
					<li>
						<a 
							class="nav-link" 
							href="/chi-sono" 
							aria-current={isActive('/chi-sono') ? 'page' : undefined}
						>
							Chi sono
						</a>
					</li>
					<li>
						<a 
							class="nav-link" 
							href="/metodo" 
							aria-current={isActive('/metodo') ? 'page' : undefined}
						>
							Metodo
						</a>
					</li>
					<li>
						<a 
							class="nav-link" 
							href="/contatti" 
							aria-current={isActive('/contatti') ? 'page' : undefined}
						>
							Contatti
						</a>
					</li>
				</ul>
			</nav>

			<!-- Right: LS Pill + Mobile Toggle -->
			<div class="header-right">
				<a 
					href="https://www.lswebagency.com" 
					target="_blank" 
					rel="noopener noreferrer" 
					class="header-pill"
					aria-label="Vai a LS Web Agency"
				>
					LS Web Agency →
				</a>

				<!-- Mobile Toggle (hidden on desktop) -->
				<button
					type="button"
					class="mobileToggle"
					aria-controls="site-menu"
					aria-expanded="false"
					aria-label="Apri menu"
					data-menu-toggle
				>
					<span class="sr-only">Menu</span>
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M5 7h14M5 12h14M5 17h14" stroke="rgb(var(--ink))" stroke-width="1.6" stroke-linecap="round"/>
					</svg>
				</button>
			</div>
		</div>
	</div>

	<!-- Overlay + Panel -->
	<div class="menu-overlay" hidden data-menu-overlay></div>
	<div
		id="site-menu"
		class="menu-panel"
		role="dialog"
		aria-modal="true"
		aria-label="Menu"
		hidden
		data-menu-panel
	>
		<div class="menu-panel-inner">
			<div class="flex items-center justify-between gap-4 mb-8">
				<p class="font-medium" style="font-size: var(--text-sm); color: rgb(var(--muted));">Menu</p>
				<button
					type="button"
					class="menu-close inline-flex items-center justify-center rounded-full"
					aria-label="Chiudi menu"
					data-menu-close
				>
					<svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
						<path d="M6 6l12 12M18 6L6 18" stroke="rgb(var(--ink))" stroke-width="1.6" stroke-linecap="round"/>
					</svg>
				</button>
			</div>

			<nav aria-label="Navigazione">
				<ul class="space-y-3" role="list">
					<li>
						<a class="menu-link" href="/case-studies" aria-current={isActive('/case-studies') ? 'page' : undefined}>Case studies</a>
					</li>
					<li>
						<a class="menu-link" href="/chi-sono" aria-current={isActive('/chi-sono') ? 'page' : undefined}>Chi sono</a>
					</li>
					<li>
						<a class="menu-link" href="/metodo" aria-current={isActive('/metodo') ? 'page' : undefined}>Metodo</a>
					</li>
					<li>
						<a class="menu-link" href="/contatti" aria-current={isActive('/contatti') ? 'page' : undefined}>Contatti</a>
					</li>
					<li>
						<a class="menu-link" href="https://www.lswebagency.com" target="_blank" rel="noopener noreferrer">LS Web Agency →</a>
					</li>
				</ul>
			</nav>
		</div>
	</div>
</header>

<div class="h-[72px]"></div>

<style>
	#header {
		background: rgb(var(--paper) / 0.7);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
		border-bottom: 1px solid transparent;
		box-shadow: none;
	}

	#header[data-header-state="scrolled"] {
		background: rgb(var(--paper) / 0.85);
		border-bottom: 1px solid rgb(var(--border) / 0.15);
		box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
	}

	/* Header layout: 3-zone flex */
	.header-inner {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
		padding-block: 1rem;
	}

	@media (min-width: 768px) {
		.header-inner {
			padding-block: 1.25rem;
		}
	}

	.header-logo {
		flex-shrink: 0;
		display: inline-flex;
		align-items: center;
	}

	/* Desktop Nav - centered but shifted right */
	.desktopNav {
		display: flex;
		margin-left: clamp(24px, 6vw, 72px);
		flex: 1;
	}

	.nav-list {
		display: flex;
		align-items: center;
		gap: 2rem;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	.header-right {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		flex-shrink: 0;
	}

	@media (min-width: 768px) {
		.header-right {
			gap: 0.75rem;
		}
	}

	.header-pill {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.5rem 1rem;
		font-size: var(--text-xs);
		font-weight: 500;
		border-radius: 9999px;
		background: transparent;
		border: 1px solid rgb(var(--border) / 0.2);
		color: rgb(var(--ink));
		text-decoration: none;
		transition: background 200ms ease, border-color 200ms ease, box-shadow 200ms ease;
	}

	.header-pill:hover {
		background: rgb(var(--accent) / 0.08);
		border-color: rgb(var(--accent) / 0.3);
		box-shadow: 0 0 0 3px rgb(var(--accent) / 0.1);
	}

	.header-pill:focus-visible {
		outline: 2px solid rgb(var(--accent));
		outline-offset: 2px;
	}

	/* Mobile Toggle - hidden by default */
	.mobileToggle {
		display: none;
		align-items: center;
		justify-content: center;
		width: 44px;
		height: 44px;
		border-radius: 9999px;
		border: 1px solid rgb(var(--border) / 0.2);
		background: rgb(var(--paper) / 0.6);
	}

	/* Mobile: hide desktop nav, show toggle */
	@media (max-width: 767px) {
		.desktopNav {
			display: none;
		}

		.mobileToggle {
			display: inline-flex;
		}
	}

	/* Nav links with animated underline */
	.nav-link {
		display: inline-flex;
		align-items: center;
		font-size: var(--text-sm);
		font-weight: 500;
		color: rgb(var(--ink));
		text-decoration: none;
		position: relative;
		padding: 4px 0;
		transition: color 240ms ease;
	}

	.nav-link::after {
		content: '';
		position: absolute;
		left: 0;
		right: 0;
		bottom: 0;
		height: 2px;
		background: rgb(var(--accent));
		transform: scaleX(0);
		transform-origin: bottom right;
		transition: transform 260ms cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* Hover: underline slides in from left */
	.nav-link:hover {
		color: rgb(var(--ink) / 0.85);
	}

	.nav-link:hover::after {
		transform: scaleX(1);
		transform-origin: bottom left;
	}

	/* Active page: underline always visible */
	.nav-link[aria-current="page"]::after {
		transform: scaleX(1);
		transform-origin: bottom left;
	}

	.nav-link:focus-visible {
		outline: 2px solid rgb(var(--accent));
		outline-offset: 4px;
		border-radius: var(--radius-sm);
	}

	.mobileToggle:hover,
	.menu-close:hover {
		background: rgb(var(--accent) / 0.06);
		border-color: rgb(var(--accent) / 0.28);
	}

	.mobileToggle:focus-visible,
	.menu-close:focus-visible {
		outline: 2px solid rgb(var(--accent));
		outline-offset: 2px;
	}

	.menu-close {
		width: 44px;
		height: 44px;
		border: 1px solid rgb(var(--border) / 0.2);
		background: rgb(var(--paper) / 0.6);
		border-radius: 9999px;
	}

	/* Menu Overlay */
	.menu-overlay {
		position: fixed;
		inset: 0;
		background: rgb(var(--ink) / 0.4);
		backdrop-filter: blur(4px);
		-webkit-backdrop-filter: blur(4px);
		opacity: 0;
		transition: opacity 200ms ease;
		z-index: var(--z-modal);
	}

	.menu-overlay.is-open {
		opacity: 1;
	}

	/* Menu Panel */
	.menu-panel {
		position: fixed;
		top: 0;
		right: 0;
		bottom: 0;
		width: min(85vw, 400px);
		background: rgb(var(--paper));
		box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
		transform: translateX(100%);
		transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1);
		z-index: calc(var(--z-modal) + 1);
		overflow-y: auto;
	}

	.menu-panel.is-open {
		transform: translateX(0);
	}

	.menu-panel-inner {
		padding: var(--space-6);
	}

	.menu-link {
		display: block;
		padding: var(--space-3) var(--space-4);
		font-size: var(--text-base);
		font-weight: 500;
		color: rgb(var(--ink));
		text-decoration: none;
		border-radius: var(--radius-md);
		transition: background 200ms ease, color 200ms ease;
	}

	.menu-link:hover {
		background: rgb(var(--accent) / 0.08);
		color: rgb(var(--accent));
	}

	.menu-link[aria-current="page"] {
		background: rgb(var(--accent) / 0.12);
		color: rgb(var(--accent));
		font-weight: 600;
	}

	.menu-link:focus-visible {
		outline: 2px solid rgb(var(--accent));
		outline-offset: 2px;
	}

	.menu-panel-inner nav ul {
		list-style: none;
		margin: 0;
		padding: 0;
	}

	/* Mobile: hide desktop LS Web Agency pill */
	@media (max-width: 767px) {
		.header-pill {
			display: none;
		}
	}

	.menu-panel-inner nav ul li:not(:last-child) {
		margin-bottom: 0;
	}

	.menu-panel-inner nav ul li:last-child {
		margin-top: var(--space-6);
		padding-top: var(--space-6);
		border-top: 1px solid rgb(var(--border) / 0.2);
	}

	.menu-panel-inner nav ul li:last-child .menu-link {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: var(--space-3) var(--space-4);
		font-size: var(--text-sm);
		font-weight: 500;
		border-radius: 9999px;
		background: transparent;
		border: 1px solid rgb(var(--border) / 0.2);
		color: rgb(var(--ink));
		text-decoration: none;
		transition: background 200ms ease, border-color 200ms ease;
	}

	.menu-panel-inner nav ul li:last-child .menu-link:hover {
		background: rgb(var(--accent) / 0.08);
		border-color: rgb(var(--accent) / 0.3);
	}

	/* Reduced motion: no transitions */
	@media (prefers-reduced-motion: reduce) {
		.nav-link,
		.nav-link::after,
		.header-pill,
		.menu-overlay,
		.menu-panel {
			transition: none;
		}
	}
</style>

<script>
	(function() {
		const toggle = document.querySelector<HTMLButtonElement>('[data-menu-toggle]');
		const overlay = document.querySelector<HTMLDivElement>('[data-menu-overlay]');
		const panel = document.querySelector<HTMLDivElement>('[data-menu-panel]');
		const closeBtn = document.querySelector<HTMLButtonElement>('[data-menu-close]');
		if (!toggle || !overlay || !panel || !closeBtn) return;

		const $toggle = toggle;
		const $overlay = overlay;
		const $panel = panel;
		const $closeBtn = closeBtn;

		const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
		const focusableSelector = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
		let lastActive: HTMLElement | null = null;

		function setExpanded(isOpen: boolean) {
			$toggle.setAttribute('aria-expanded', String(isOpen));
			$toggle.setAttribute('aria-label', isOpen ? 'Chiudi menu' : 'Apri menu');
		}

		function lockScroll(isLocked: boolean) {
			if (isLocked) {
				document.documentElement.dataset.menuOpen = 'true';
				document.documentElement.style.overflow = 'hidden';
			} else {
				delete document.documentElement.dataset.menuOpen;
				document.documentElement.style.overflow = '';
			}
		}

		function openMenu() {
			if (!$panel.hasAttribute('hidden')) return;

			lastActive = document.activeElement instanceof HTMLElement ? document.activeElement : null;
			$overlay.removeAttribute('hidden');
			$panel.removeAttribute('hidden');
			requestAnimationFrame(() => {
				$overlay.classList.add('is-open');
				$panel.classList.add('is-open');
			});

			setExpanded(true);
			lockScroll(true);

			const focusables = $panel.querySelectorAll<HTMLElement>(focusableSelector);
			const target = focusables[0] || $panel;
			target.focus();
		}

		function closeMenu() {
			if ($panel.hasAttribute('hidden')) return;

			$overlay.classList.remove('is-open');
			$panel.classList.remove('is-open');

			setExpanded(false);
			lockScroll(false);

			const finish = () => {
				$overlay.setAttribute('hidden', '');
				$panel.setAttribute('hidden', '');
				lastActive?.focus();
				lastActive = null;
			};

			if (prefersReducedMotion) {
				finish();
			} else {
				window.setTimeout(finish, 180);
			}
		}

		function onKeyDown(e: KeyboardEvent) {
			if (e.key === 'Escape') {
				closeMenu();
				return;
			}

			// Focus trap when open
			if (e.key === 'Tab' && !$panel.hasAttribute('hidden')) {
				const focusables = Array.from($panel.querySelectorAll<HTMLElement>(focusableSelector));
				if (focusables.length === 0) return;
				const first = focusables[0];
				const last = focusables[focusables.length - 1];
				const active = document.activeElement;

				if (e.shiftKey && active === first) {
					e.preventDefault();
					last.focus();
				} else if (!e.shiftKey && active === last) {
					e.preventDefault();
					first.focus();
				}
			}
		}

		$toggle.addEventListener('click', () => {
			if ($panel.hasAttribute('hidden')) openMenu();
			else closeMenu();
		});

		$closeBtn.addEventListener('click', closeMenu);
		$overlay.addEventListener('click', closeMenu);
		document.addEventListener('keydown', onKeyDown);

		$panel.querySelectorAll<HTMLAnchorElement>('a[href]').forEach((a) => {
			a.addEventListener('click', closeMenu);
		});
	})();
</script>
